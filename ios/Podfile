# Podfile for Flutter iOS (Xcode 15/16)
platform :ios, '15.5'
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

workspace 'Runner.xcworkspace'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

# ---- Resolve FLUTTER_ROOT from ios/Flutter/Generated.xcconfig (safe on CI)
def resolved_flutter_root
  generated = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated)
    raise "#{generated} must exist. Run 'flutter pub get' first."
  end
  File.foreach(generated) do |line|
    m = line.match(/FLUTTER_ROOT\=(.*)/)
    return m[1].strip if m
  end
  raise "FLUTTER_ROOT not found in #{generated}."
end

# Load Flutter podhelper (DO NOT use ENV['FLUTTER_ROOT'])
require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), resolved_flutter_root)

# Flutter CocoaPods setup
flutter_ios_podfile_setup

target 'Runner' do
  # Frameworks are safest for mixed Swift/ObjC plugins
  use_frameworks! :linkage => :static
  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
end

# ========== GLOBAL SCRUB ==========
# Remove any appearance of -G or the two-token form "-G 0" etc
def strip_g_tokens(arr)
  a = Array(arr).flatten.compact.map(&:to_s)
  cleaned = []
  skip_next = false
  a.each_with_index do |tok, i|
    if skip_next
      skip_next = false
      next
    end
    if tok == '-G'
      # drop this and a following numeric if present
      nxt = a[i+1]
      skip_next = (!!nxt && nxt.match?(/\A\d+\z/))
      next
    elsif tok.match?(/\A-G\d+\z/)
      # single-token form (-G1, -G0, etc)
      next
    else
      cleaned << tok
    end
  end
  cleaned
end

# Keys where -G sometimes hides
ALL_FLAG_KEYS = %w[
  OTHER_CFLAGS
  OTHER_CPLUSPLUSFLAGS
  OTHER_LDFLAGS
  USER_HEADER_SEARCH_PATHS
  HEADER_SEARCH_PATHS
  WARNING_CFLAGS
  GCC_PREPROCESSOR_DEFINITIONS
  OTHER_LIBTOOLFLAGS
  LIBRARY_SEARCH_PATHS
  SWIFT_ACTIVE_COMPILATION_CONDITIONS
  OTHER_SWIFT_FLAGS
  LD_RUNPATH_SEARCH_PATHS
]

post_install do |installer|
  ios_target = '15.5'

  # Keep Flutter defaults
  flutter_post_install(installer) if defined?(flutter_post_install)

  # Scrub Pods project first
  [installer.pods_project, *installer.aggregate_targets.map(&:user_project).uniq].each do |project|
    project.build_configurations.each do |cfg|
      cfg.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = ios_target
      ALL_FLAG_KEYS.each do |k|
        v = cfg.build_settings[k]
        next if v.nil?
        cfg.build_settings[k] = strip_g_tokens(v)
      end
    end

    project.targets.each do |t|
      t.build_configurations.each do |cfg|
        cfg.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = ios_target
        cfg.build_settings['ENABLE_BITCODE'] = 'NO'
        ALL_FLAG_KEYS.each do |k|
          v = cfg.build_settings[k]
          next if v.nil?
          cfg.build_settings[k] = strip_g_tokens(v)
        end
      end
    end
  end

  # Extra hardening: purge -G from all Pods-generated xcconfigs on disk
  Dir.glob(File.join(installer.sandbox.root, 'Target Support Files', '**', '*.xcconfig')).each do |path|
    txt = File.read(path)
    # remove '-G' followed by optional space + digits, and collapse double spaces
    txt = txt.gsub(/(^|[\s])\-G(\s+\d+)?(?=[\s]|$)/, ' ')
             .gsub(/  +/, ' ')
             .gsub(/\s+\n/, "\n")
    File.write(path, txt)
  end
end
# ========== /GLOBAL SCRUB ==========
